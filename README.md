# Internal_AI_tool
Internal AI Tool は、Streamlit 製の社内向け AI ツールです。AI チャット、Web 検索、画像生成、RAG 管理に加え、設計差分に基づくコード改修ツールを備えています。本 README だけで使い方と仕様が分かるよう詳細に記載しています。

**重要:** 本ツールは OpenAI の API を使用します。入力テキスト・チャット履歴・アップロードしたファイル（RAG）・コード改修に使う設計書/コードは OpenAI に送信されます。機密情報の取り扱いに注意してください。

## 動作環境
- Python: 3.11+
- 依存パッケージ（主要）:
  - openai==1.76.0
  - streamlit==1.33.0
  - python-dotenv==1.1.1

## 環境変数 (.env)
- `OPENAI_API_KEY`: OpenAI API キー（必須）
- `DEFAULT_MODEL`: 既定のモデル名。省略時は `gpt-5-mini`

フレンドリ名と実モデル ID の対応（UI でも同名を選択可能）:
- `gpt-5` → `gpt-5`
- `gpt-5-mini` → `gpt-5-mini`
- `gpt-5-nano` → `gpt-5-nano`
- `o4-mini` → `o4-mini`

`DEFAULT_MODEL` には上記フレンドリ名のほか、実モデル ID をそのまま指定しても利用できます（未知値の場合は `gpt-5-mini` にフォールバック）。

## セットアップと起動
1) 依存パッケージをインストール
   - `pip install -r requirements.txt`
2) `.env` を作成し `OPENAI_API_KEY` を設定（必要に応じて `DEFAULT_MODEL` も）
3) 起動
   - `streamlit run app.py`

## 画面構成（サイドバー）
- ツール選択: `AIツール` / `コード改修ツール`
  - `AIツール`: 「AIチャット / Web検索 / 画像生成 / RAG管理 / 設定」のタブ構成
  - `コード改修ツール`: 実行用と設定用の 2 タブ構成

---

## AIツール（タブ詳細）

### AIチャット
- 概要: OpenAI Responses API を使用したストリーミングチャット。
- RAG 設定（Expander 内）
  - `RAG（file_search）を使用` を有効化すると、選択した Vector Store を検索に使用。
  - 「ストア一覧を再読込」で最新のストアを取得。
  - 複数ストア選択可。Responses API の `file_search` ツールで参照します。
- 入出力
  - 入力欄は画面下部に固定。送信するとメッセージが上に積み上がります。
  - 応答はストリーム表示。会話の継続には `previous_response_id` を内部的に利用。
  - 「履歴クリア」で会話履歴と `previous_response_id` をリセット。
- ダウンロード（履歴）
  - 形式: `md` / `json` / `txt`（「設定」タブの選択が反映）
  - 改行コード: `CRLF` / `LF`（同上）
  - MD では「# Chat Transcript」「## Role (timestamp)」の体裁で保存。

### Web検索
- 概要: `web_search` ツールを使った検索応答。
- モデル: 実質 `gpt-5-mini` 固定。
- 使い方: クエリ入力 → 検索。検索中はステータス表示。結果をそのまま表示。

### 画像生成
- 概要: OpenAI Images API（`gpt-image-1`）で画像を生成。
- 入力: プロンプト、サイズ（`1024x1024` / `1024x1536` / `1536x1024` / `auto`）
- 出力: 画像を表示。複数返る場合は 3 枚/行のグリッドで表示。

### RAG管理
- ベクターストア
  - 一覧表示・再読込 / 作成 / 名称変更 / 削除。
- ファイル管理
  - 選択したストア内のファイル一覧・再読込 / 追加（複数可）/ 削除。
  - 追加時はその場で OpenAI の Vector Store にアップロードされます。

### 設定
- モデル選択（AIチャット用）: `gpt-5` / `gpt-5-mini` / `gpt-5-nano` / `o4-mini`
- ダウンロード設定（AIチャット履歴・コード改修履歴共通）
  - ファイルタイプ: `md` / `json` / `txt`
  - 改行コード: `CRLF` / `LF`
- 現在設定の確認: JSON を画面表示。

---

## コード改修ツール（詳細仕様）
Responses API を 2 段階で利用して、設計差分の抽出 → コード改修を行います。改修後は追い質問ベースで差分適用を重ねられます。

### 設定タブ
- モデル選択（コード改修用）: `gpt-5` / `gpt-5-mini` / `gpt-5-nano` / `o4-mini`
- プロンプト編集
  - Step1（設計差分抽出）テンプレート
  - Step2（コード改修）テンプレート
  - 任意に書き換え可能。用途に応じてトーンや出力規則を調整してください。

### 実行タブ
- 入力ファイル（必須・3 点）
  - INPUT1: 改修対象コード（`*.py` / `*.sql`）
  - INPUT2: 設計書（改修前、`*.txt` / `*.md`）
  - INPUT3: 設計書（改修後、`*.txt` / `*.md`）
- 一括実行の流れ
  1) Step1: INPUT2/INPUT3 の差分要約を生成（日本語・箇条書き）。
  2) Step2: Step1 の要約と INPUT1（元コード）を基に完全な改修コードを生成。
  3) 差分（unified diff）を表示し、改修後コードを表示・保存可能。
- 出力とダウンロード
  - 修正後コードは `modified_{元ファイル名}` でダウンロード（拡張子は元ファイルに追従）。
  - 差分は `diff` 表示のみ（テキストコピー可能）。

### 追い質問（追加修正）
- 改修後コードがある状態で、下部の入力欄から追加の要望を送信。
- システムプロンプトで「説明やコードフェンスを含めず、完全なコードのみを返す」よう強制。
- 毎回、前回コードとの差分を計算して画面に反映。履歴はダウンロード可能。

### 全履歴ダウンロード
- Step1/Step2/追い質問の全リクエスト・レスポンスをまとめてダウンロード可能。
- 形式: `md` / `json` / `txt`（「設定」タブのダウンロード設定が反映）。

---

## 仕様詳細（動作の前提・内部仕様）
- モデル名の解決: フレンドリ名（上記）→ 実モデル ID に解決。未知値は `gpt-5-mini` にフォールバック。
- 会話の継続: Responses API の `previous_response_id` を内部的に利用して前回応答に接続。
- RAG の有効化: `file_search` ツールに選択ストア ID を渡して参照。使わない場合はツール未指定。
- ダウンロードの改行変換: 表示用に LF 正規化後、指定が `CRLF` の場合は `\r\n` に変換。
- キャッシュ:
  - OpenAI クライアントは `st.cache_resource` で 1 度だけ作成。
  - ベクターストア/ファイル一覧は `st.cache_data` でキャッシュし、作成/更新/削除/アップロード実行時にクリア。
- エラー表示:
  - 直近のエラーを各画面上部に表示（チャット/検索/画像/コード改修）。

## 既知の制限・注意事項
- トークン制限により長文や大きなファイルは要約・分割が必要な場合があります。
- Web 検索の品質・出典はモデル応答に依存します。
- コード改修の精度はプロンプトと入力品質に依存します（必要に応じてテンプレートを調整してください）。
- RAG は OpenAI の Vector Store を使用します。アップロードしたファイルは外部（OpenAI）に保存されます。

## ライセンス/著作権
社内利用を前提としています（外部配布は想定していません）。
